name: Stale Work Detection

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9 AM
  workflow_dispatch: # Allow manual trigger

jobs:
  check-stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Check stale in-progress issues
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          
          # Issue configuration
          stale-issue-message: |
            ## 📊 Status Check Required
            
            This issue has been marked as `in-progress` for 14 days without updates.
            
            Please provide a status update:
            - What progress has been made?
            - Are there any blockers?
            - Do you need help or should this be reassigned?
            
            If no update is provided within 7 days, this issue may be unassigned to allow others to work on it.
          
          stale-issue-label: 'status: needs-update'
          only-labels: 'in-progress'
          days-before-issue-stale: 14
          days-before-issue-close: -1 # Don't auto-close
          
          # PR configuration
          stale-pr-message: |
            ## 👀 PR Status Check
            
            This pull request has had no activity for 7 days.
            
            Please:
            - Push any pending changes
            - Respond to review comments
            - Mark as ready for review if in draft
            - Or close if no longer needed
            
            This PR may be closed automatically if there's no activity for another 7 days.
          
          stale-pr-label: 'status: needs-update'
          days-before-pr-stale: 7
          days-before-pr-close: 14
          
          # Exemptions
          exempt-issue-labels: 'critical,security,production'
          exempt-pr-labels: 'critical,security,production'
          exempt-all-milestones: false
          
          # Operations
          operations-per-run: 30
          remove-stale-when-updated: true
          
      - name: Generate stale work report
        uses: actions/github-script@v7
        with:
          script: |
            // Find all issues that are in-progress but haven't been updated
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 7);
            
            const inProgressIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'in-progress',
              state: 'open',
              per_page: 100
            });
            
            const staleIssues = inProgressIssues.data.filter(issue => {
              const lastUpdate = new Date(issue.updated_at);
              return lastUpdate < cutoffDate;
            });
            
            if (staleIssues.length > 0) {
              // Create a summary issue
              const reportBody = `## 📊 Weekly Stale Work Report
            
            The following issues have been in progress but haven't been updated recently:
            
            | Issue | Assignee | Last Updated | Days Stale |
            |-------|----------|--------------|------------|
            ${staleIssues.map(issue => {
              const daysSinceUpdate = Math.floor((new Date() - new Date(issue.updated_at)) / (1000 * 60 * 60 * 24));
              const assignees = issue.assignees.map(a => `@${a.login}`).join(', ') || 'Unassigned';
              return `| #${issue.number} ${issue.title} | ${assignees} | ${new Date(issue.updated_at).toLocaleDateString()} | ${daysSinceUpdate} days |`;
            }).join('\n')}
            
            ### Recommended Actions:
            1. Check in with assignees for status updates
            2. Identify and address any blockers
            3. Consider reassigning if work is abandoned
            4. Update issue status if work is complete
            
            *This report was automatically generated by the stale work detection workflow.*`;
            
              // Check if we already have a report issue open
              const existingReports = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'automated',
                state: 'open',
                creator: 'github-actions[bot]'
              });
              
              const hasRecentReport = existingReports.data.some(issue => 
                issue.title.includes('Weekly Stale Work Report') &&
                (new Date() - new Date(issue.created_at)) < 7 * 24 * 60 * 60 * 1000
              );
              
              if (!hasRecentReport) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `📊 Weekly Stale Work Report - ${new Date().toLocaleDateString()}`,
                  body: reportBody,
                  labels: ['automated', 'documentation']
                });
              }
            }

  check-abandoned-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Find abandoned PRs
        uses: actions/github-script@v7
        with:
          script: |
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const allPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc',
              per_page: 100
            });
            
            const abandonedPRs = allPRs.data.filter(pr => {
              const lastUpdate = new Date(pr.updated_at);
              return lastUpdate < thirtyDaysAgo && !pr.draft;
            });
            
            for (const pr of abandonedPRs) {
              // Post a comment on very old PRs
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `## 🕰️ Long-Running PR Detected
                
                This PR has been open for over 30 days without activity.
                
                **Options:**
                1. If this is still needed, please rebase and update
                2. Convert to draft if work is ongoing
                3. Close if no longer relevant
                
                Long-running PRs can:
                - Accumulate merge conflicts
                - Block related work
                - Become outdated with current codebase
                
                Please take action within the next 7 days.`
              });
              
              // Add a label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['status: needs-attention']
              }).catch(err => {
                console.log(`Could not add label to PR #${pr.number}: ${err.message}`);
              });
            }